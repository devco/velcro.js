!function(t){"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?t(module.exports||exports):"function"==typeof define&&define.amd?define(["exports"],t):t(window.ku={})}(function(t){function e(t,e){return t?("object"==typeof t&&t.constructor&&(t=t.constructor),"function"==typeof t&&(t=""+t),t===e):!1}function n(t,e){if(t=t||[],"string"==typeof t&&(t=[t]),"number"==typeof t.length){for(var n=0;t.length>n;n++)if(e(n,t[n])===!1)return}else for(var i in t)if(e(i,t[i])===!1)return}function i(e){var n=t.value();return n.owner=e,n.getter=function(){return this},n.setter=function(t){this.from(t)},n}function r(e,i){n(i,function(n,i){if(t.utils.isModel(i)||t.utils.isCollection(i))return e.relations[n]=i,void 0;if("function"==typeof i){var r,s;return t.utils.isReader(n)?(r=t.utils.fromReader(n),s="getter"):t.utils.isWriter(n)&&(r=t.utils.fromWriter(n),s="setter"),s?(e.computed[r]===void 0&&(e.computed[r]={}),e.computed[r][s]=i,void 0):(e.methods[n]=i,void 0)}e.properties[n]=i})}function s(t){t.observer=i(t),o(t),u(t),c(t),a(t)}function o(e){n(e.$self.computed,function(n,i){e[n]=t.value({owner:e,getter:i.getter,setter:i.setter})})}function u(t){n(t.$self.methods,function(e,n){t[e]=function(){return n.apply(t,arguments)}})}function c(e){n(e.$self.properties,function(n,i){e[n]=t.value({value:i})})}function a(t){n(t.$self.relations,function(e,n){var i=new n;t[e]=i.observer,i.$parent=t})}function h(t){return t.replace(/http(s)?\:\/\/[^\/]+/,"")}function f(t){window.addEventListener?window.addEventListener(t,l,!1):window["on"+t]=l}function p(t){document.createEvent?(event=document.createEvent("HTMLEvents"),event.initEvent(t,!0,!0),window.dispatchEvent(event)):window["on"+t](document.createEventObject())}function d(t,e){if(!e){var n=t.replace(/^#/,""),i=document.getElementById(n),r=window.pageXOffset?window.pageXOffset:document.body.scrollLeft,s=window.pageYOffset?window.pageYOffset:document.body.scrollTop,o=document.createElement("div");i&&(i.id=""),o.id=n||"_",o.style.position="absolute",o.style.width=0,o.style.height=0,o.style.left=r+"px",o.style.top=s+"px",o.style.padding=0,o.style.margin=0,document.body.appendChild(o),window.location.hash="#"+o.id,document.body.removeChild(o),i&&(i.id=n)}}function l(){for(var t=0;m.length>t;t++)m[t].dispatch()}t.App=function(){this.attributePrefix="data-ku-",this.bindings=t.defaultBindings,this.context={}},t.App.prototype={run:function(t,e){e||(e=t,t=document),this.context=e,this.bindAll(t)},bindAll:function(t){return this.bindOne(t),this.bindDescendants(t),this},bindOne:function(t){var e=this;return n(t.attributes,function(n,i){var r=i.nodeName.substring(e.attributePrefix.length);"function"==typeof e.bindings[r]&&e.bindAttribute(t,r,i)}),this},bindDescendants:function(t){var e=this;return n(t.childNodes,function(t,n){e.bindAll(n,e.context)}),this},bindAttribute:function(e,i,r){var s=this,o=t.utils.parseBinding(r.nodeValue,s.context);return this.bindings[i].call(this.bindings[i],this,e,o),n(o,function(n,o){t.utils.isObserved(o)&&o.__ku_observer.subscribe(function(){s.bindAttribute(e,i,r)})}),this}},t.collection=function(e){var r=function(r){Array.prototype.push.apply(this,[]),this.observer=i(this),this.aggregate=function(t,e){var i=[];return e||(e=[t],t=""),this.each(function(r,s){var o=[];n(e,function(t,e){"function"==typeof s[e]&&o.push(s[e]())}),i.push(o.join(t))}),i},this.at=function(t){return this[t]===void 0?!1:this[t]},this.first=function(){return this.at(0)},this.last=function(){return this.at(this.length-1)},this.has=function(t){return this[t]!==void 0},this.remove=function(t){return t="number"==typeof t?t:this.index(t),this.has(t)&&(Array.prototype.splice.call(this,t,1),this.observer.publish()),this},this.empty=function(){return Array.prototype.splice.call(this,0,this.length),this.observer.publish(),this},this.prepend=function(t){return this.insert(0,t)},this.append=function(t){return this.insert(this.length,t)},this.insert=function(n,i){return i=t.utils.isModel(i)?i:new e(i),i.$parent=this.$parent,Array.prototype.splice.call(this,n,0,i),this.observer.publish(),this},this.replace=function(n,i){return i=t.utils.isModel(i)?i:new e(i),i.$parent=this.$parent,Array.prototype.splice.call(this,n,1,i),this.observer.publish(),this},this.index=function(t){var e=-1;return this.each(function(n,i){return i===t?(e=n,void 0):void 0}),e},this.from=function(e){var i=this;return t.utils.isCollection(e)&&(e=e.raw()),n(e,function(t,e){i.has(t)?i.replace(t,e):i.replace(t,e)}),this},this.raw=function(){var t=[];return this.each(function(e,n){t.push(n.raw())}),t},this.each=function(t){for(var e=0;this.length>e;e++)t.call(this,e,this[e]);return this},this.find=function(e,i,r){var s=new this.$self.Model.Collection;return s.$parent=this.$parent,t.utils.isModel(e)&&(e=e.raw()),"object"==typeof e&&(e=function(t){return function(){var e=this,i=!0;return n(t,function(t,n){return e[t]===void 0||e[t]()!==n?(i=!1,!1):void 0}),i}}(e)),this.each(function(t,n){if(i&&r){var o=i*r-i;if(t>o)return}return e.call(n,t)&&s.append(n),i&&s.length===i?!1:void 0}),s},this.findOne=function(t){return this.find(t,1).first()},this["export"]=this.raw,this["import"]=this.from,this.from(r)};return r.Model=e,r.prototype={$self:r},r};var v=function(t,e,n){t.context=n.context},w=function(e,n,i){var r=i.view||new t.View;r.target=n,r.render(i.path,i.context)},g=function(e,n,i){var r=i.router;r||t.utils.throwForElement(n,'Cannot bind router "'+value+'" to the main view because it does not exist.'),!r instanceof t.Router&&t.utils.throwForElement(n,'Cannot bind router "'+value+'" to the main view because it is not an instanceof "ku.Router".'),r.view.target=n,r.bind()},b=function(t,e,n){e.innerText=n.text};t.defaultBindings={context:v,include:w,routable:g,text:b},t.Event=function(){return this.stack=[],this},t.Event.prototype={bind:function(t){return this.stack.push(t),this},unbind:function(t){if(t){var e=[];for(var n in this.stack)this.stack[n]!==t&&e.push(this.stack[n]);this.stack=e}else this.stack=[];return this},trigger:function(t){for(var e in this.stack)if(this.stack[e].apply(this,t)===!1)return!1}},t.Events=function(){return this.events={},this},t.Events.prototype={on:function(e,n){return this.events[e]===void 0&&(this.events[e]=new t.Event),this.events[e].bind(n),this},off:function(t,e){return t?(this.events[t]!==void 0&&this.events[t].unbind(e),this):(this.events={},this)},trigger:function(t,e){return this.events[t]!==void 0&&this.events[t].trigger(e)===!1?!1:void 0}},t.Http=function(){return this.events=new t.Events,this},t.Http.prototype={prefix:"",suffix:"",headers:{},parsers:{"application/json":function(t){try{return JSON.parse(t)}catch(e){throw'Error parsing response "'+t+'" with message "'+e+'".'}}},"delete":function(t,e,n){return this.request(t,e||{},"delete",n||e)},get:function(t,e,n){return this.request(t,e||{},"get",n||e)},head:function(t,e,n){return this.request(t,e||{},"head",n||e)},options:function(t,e,n){return this.request(t,e||{},"options",n||e)},patch:function(t,e,n){return this.request(t,e,"patch",n)},post:function(t,e,n){return this.request(t,e,"post",n)},put:function(t,e,n){return this.request(t,e,"put",n)},request:function(e,n,i,r){var s=this,o=this.createRequestObject();o.open(i.toUpperCase(),this.prefix+e+this.suffix,!0);for(var u in this.headers)o.setRequestHeader(u,this.headers[u]);return o.onreadystatechange=function(){if(4===o.readyState){if(200!==o.status&&304!==o.status)return s.events.trigger("error",[o]),s.events.trigger("stop",[o]),void 0;var t=o.responseText,e=o.getAllResponseHeaders();"string"==typeof e["Content-Type"]&&"function"==typeof s.parsers[e["Content-Type"]]?t=s.parsers[e["Content-Type"]](t):"string"==typeof s.headers.Accept&&"function"==typeof s.parsers[s.headers.Accept]&&(t=s.parsers[s.headers.Accept](t)),"function"==typeof r&&r(t,o),s.events.trigger("success",[t,o]),s.events.trigger("stop",[o])}},4!==o.readyState?(t.utils.isModel(n)&&(n=n.raw()),"object"==typeof n&&(n=this.serialize(n)),n&&o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),this.events.trigger("start",[o]),o.send(n),this):void 0},serialize:function(t,e){var n=[];for(var i in t){var r=e?e+"["+i+"]":i,s=t[i];n.push("object"==typeof s?this.serialize(s,r):encodeURIComponent(r)+"="+encodeURIComponent(s))}return n.join("&")},createRequestObject:function(){var t=!1;factories=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}];for(var e=0;factories.length>e;e++)try{t=factories[e]()}catch(n){continue}if(!t)throw"An XMLHttpRequest could not be generated.";return t}},t.model=function(e){var i=function(e){var r=this;this.clone=function(){var t=new i(this.raw());return t.$parent=this.$parent,t},this.from=function(e){return t.utils.isModel(e)&&(e=e.raw()),n(e,function(t,e){"function"==typeof r[t]&&r[t](e)}),this.observer.publish(),this},this.raw=function(){var t={};return n(r.$self.properties,function(e){t[e]=r[e]()}),n(r.$self.computed,function(e){t[e]=r[e]()}),n(r.$self.relations,function(e){t[e]=r[e]().raw()}),t},this.reset=function(){return n(r.$self.properties,function(t,e){r[t](e)}),this},this["export"]=this.raw,this["import"]=this.from,s(this),this.from(e),"function"==typeof this.init&&this.init()};return i.Collection=t.collection(i),i.computed={},i.methods={},i.properties={},i.relations={},i.prototype.$self=i,i.extend=function(e){return e=t.utils.isModel(e)?e:t.model(e),n(i.computed,function(t,n){e.computed[t]===void 0&&(e.computed[t]=n)}),n(i.methods,function(t,n){e.methods[t]===void 0&&(e.methods[t]=n)}),n(i.properties,function(t,n){e.properties[t]===void 0&&(e.properties[t]=n)}),n(i.relations,function(t,n){e.relations[t]===void 0&&(e.relations[t]=n)}),e},i.inherit=function(t){return t.extend(i)},r(i,e),i};var m=[];t.Router=function(){return this.app=new t.App,this.events=new t.Events,this.routes={},this.state=new t.State,this.view=new t.View,this},t.Router.prototype={handler:function(t){t()},renderer:function(e,n){var i=this;this.app.context=e.controller.apply(e.controller,n),this.app.context=new(t.model(this.app.context)),this.view.render(e.view,function(){i.app.bindDescendants(this.target),i.events.trigger("render",[i,e,n])})},bind:function(){return this.unbind(),m.push(this),"onpopstate"in window&&this.state.enabled&&(!this.state.enabled||window.location.hash)||this.dispatch(),this},unbind:function(){for(var t=0;m.length>t;t++)this===m[t]&&delete m[t];return this},set:function(e,n){return"function"==typeof n&&(n={match:RegExp("^"+e+"$"),format:e,controller:n}),n.view||(n.view=e),this.routes[e]=n instanceof t.Route?n:new t.Route(n),this},get:function(t){if(this.has(t))return this.routes[t];throw'Route "'+t+'" does not exist.'},has:function(t){return this.routes[t]!==void 0},remove:function(t){return this.has(t)&&delete this.routes[t],this},dispatch:function(t){var e=this;t===void 0&&(t=this.state.get());var n=function(){e.renderer(r)};for(var i in this.routes){var r=this.routes[i],s=r.query(t);"number"==typeof s.length&&(this.events.trigger("match",[this,t,r,s]),this.state.previous=t,this.handler(n))}return this},go:function(t,e,n){return this.state.push(this.get(t).generate(e),n),this},generate:function(t,e){return this.get(t).generate(e)}},t.Route=function(t){for(var e in t)this[e]=t[e];return this},t.Route.prototype={match:/.*/,format:"",view:!1,controller:function(){},query:function(t){var e=t.match(this.match);return null===e?!1:(e.shift(),e)},generate:function(t){var e=this.format;for(var n in t)e=e.replace(RegExp("\\:"+n,"g"),t[n]);return e}};var y,x=window.location.hash,E=!1;t.State=function(){return this.states={},t.State.start(),this},t.State.interval=500,t.State.start=function(){if(E)return t.State;var e="onhashchange"in window&&/MSIE\s(6|7)/.test(navigator.userAgent);return"onpopstate"in window?f("popstate"):e?(f("hashchange"),y=setInterval(function(){x!==window.location.hash&&(x=window.location.hash,p("hashchange"))},t.State.interval)):f("hashchange"),E=!0,t.State},t.State.stop=function(){y&&clearInterval(y);var t="onpopstate"in window?"popstate":"hashchange";return window.removeEventListener?window.removeEventListener(t,l):window[t]&&delete window[t],E=!1,State},t.State.prototype={previous:!1,enabled:!1,scroll:!1,get:function(){return this.enabled&&window.history.pushState?h(window.location.href):window.location.hash.substring(1)},push:function(t,e,n){return this.enabled&&window.history.pushState?(window.history.pushState(e,n,t||"."),l()):d(t,this.scroll),this.states[t]=e,this},data:function(t){return t=t||this.get(),this.states[t]===void 0?null:this.states[t]}},t.utils={parseBinding:function(t,e){var n="";for(var i in e||{})"import"!==i&&"export"!==i&&""!==i&&(n+="var "+i+"=__context['"+i+"'];");n+="return {"+t+"};";try{return Function("__context",n)(e)}catch(r){throw'Error parsing binding "'+t+'" with message: "'+r+'"'}},isObserved:function(e){return t.utils.canBeObserved(e)&&e.__ku_observer},canBeObserved:function(t){return t!==void 0&&null!==t},outerHtml:function(t){var e=document.createElement("div");return e.appendChild(t),e.innerHTML},throwForElement:function(e,n){throw n+"\n"+t.outerHtml(e)},isReader:function(t){return 0===t.indexOf("read")},isWriter:function(t){return 0===t.indexOf("write")},toReader:function(t){return"read"+t.substring(0,1).toUpperCase()+t.substring(1)},toWriter:function(t){return"write"+t.substring(0,1).toUpperCase()+t.substring(1)},fromReader:function(t){return t.substring(4,5).toLowerCase()+t.substring(5)},fromWriter:function(t){return t.substring(5,6).toLowerCase()+t.substring(6)},isModel:function(n){return e(n,""+t.model())},isCollection:function(n){return e(n,""+t.collection())}},t.value=function(e){var i=function(e){return 0===arguments.length?(e=i.getter.call(i.owner),t.utils.canBeObserved(e)&&(e.__ku_observer=i),e):(i.setter.call(i.owner,e),i.publish(),i.owner)};e||(e={}),"function"!=typeof e.getter&&(e.getter=function(){return r}),"function"!=typeof e.setter&&(e.setter=function(t){r=t});var r=e.value,s=[];return i.owner=e.owner,i.getter=e.getter,i.setter=e.setter,i.subscribe=function(t){return s.push(t),i},i.unsubscribe=function(t){return n(s,function(e,n){return t===n?(s.splice(e,1),void 0):void 0}),i},i.publish=function(){n(s,function(t,e){e(r)})},i},t.View=function(){return this.cache={},this.http=new t.Http,this.http.prefix="views/",this.http.suffix=".html",this.http.accept="text/html",this},t.View.prototype={http:!1,target:null,idPrefix:"ku-view-",idSuffix:"",idSeparator:"-",render:function(t,e){var n=this,i=this.idPrefix+t.replace(/\//g,this.idSeparator)+this.idSuffix;return this.cache[t]?(this.renderer(this.cache[t]),e.call(this,t)):document.getElementById(i)?(this.renderer(this.cache[t]=document.getElementById(i).innerHTML),e.call(this,t)):this.http&&this.http.get(t,function(i){n.renderer(n.cache[t]=i),e.call(n,t)}),this},renderer:function(t){var e=this.target;if(!e)throw"Cannot render view because no target was specified.";"string"==typeof e?e=document.getElementById(e):"function"==typeof e&&(e=e()),e.innerHTML=t}}});