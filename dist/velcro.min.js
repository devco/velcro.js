!function(t){"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?t(module.exports||exports):"function"==typeof define&&define.amd?define(["exports"],t):t(window.Velcro={})}(function(t){function e(){for(var t=!1,e=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}],n=0;e.length>n;n++)try{t=e[n]()}catch(i){continue}if(!t)throw"An XMLHttpRequest could not be generated.";return t}function n(t,e){return t?("object"==typeof t&&t.constructor&&(t=t.constructor),"function"==typeof t&&(t=""+t),t===e):!1}function i(t,e){if(t=t||[],"string"==typeof t&&(t=[t]),"number"==typeof t.length){for(var n=0;t.length>n;n++)if(e(n,t[n])===!1)return}else for(var i in t)if(e(i,t[i])===!1)return}function r(e){return t.value({value:e,bind:e,set:function(t){this.from(t)}})}function o(e,n){i(n,function(n,i){if(t.utils.isModel(i)||t.utils.isCollection(i))return e.relations[n]=i,void 0;if("function"==typeof i){var r,o;return 0===n.indexOf("get")?(r=n.substring(3,4).toLowerCase()+n.substring(4),o="get"):0===n.indexOf("set")&&(r=n.substring(3,4).toLowerCase()+n.substring(4),o="set"),o?(e.computed[r]===void 0&&(e.computed[r]={}),e.computed[r][o]=i,void 0):(e.methods[n]=i,void 0)}e.properties[n]=i})}function s(t){t.observer=r(t),u(t),a(t),c(t),h(t)}function u(e){i(e.$self.computed,function(n,i){e[n]=t.value({bind:e,get:i.get,set:i.set})})}function a(t){i(t.$self.methods,function(e,n){t[e]=function(){return n.apply(t,arguments)}})}function c(e){i(e.$self.properties,function(n,i){e[n]=t.value({bind:e,value:i})})}function h(t){i(t.$self.relations,function(e,n){var i=new n;t[e]=i.observer,i.$parent=t})}function f(t){return t.replace(/http(s)?\:\/\/[^\/]+/,"")}function p(t){window.addEventListener?window.addEventListener(t,v,!1):window["on"+t]=v}function l(t){document.createEvent?(event=document.createEvent("HTMLEvents"),event.initEvent(t,!0,!0),window.dispatchEvent(event)):window["on"+t](document.createEventObject())}function d(t,e){if(!e){var n=t.replace(/^#/,""),i=document.getElementById(n),r=window.pageXOffset?window.pageXOffset:document.body.scrollLeft,o=window.pageYOffset?window.pageYOffset:document.body.scrollTop,s=document.createElement("div");i&&(i.id=""),s.id=n||"_",s.style.position="absolute",s.style.width=0,s.style.height=0,s.style.left=r+"px",s.style.top=o+"px",s.style.padding=0,s.style.margin=0,document.body.appendChild(s),window.location.hash="#"+s.id,document.body.removeChild(s),i&&(i.id=n)}}function v(){for(var t=0;m.length>t;t++)m[t].dispatch()}t.App=function(){this.attributePrefix="data-velcro-",this.bindings=t.defaultBindings,this.contexts=[]},t.App.prototype={bind:function(t,e){return 1===arguments.length&&(e=t,t=document),this.context(e),this.bindOne(t),this.bindDescendants(t),this.restoreContext(),this},bindDescendants:function(t,e){var n=this;return i(t.childNodes,function(t,i){n.bind(i,e)}),this},bindOne:function(t){var e=this;return i(t.attributes,function(n,i){var r=i.nodeName.substring(e.attributePrefix.length);"function"==typeof e.bindings[r]&&e.bindAttribute(t,r,i.nodeValue)}),this},bindAttribute:function(e,n,r){function o(){var t=u();"function"==typeof h.init?h.init.call(h,a,e,t):h.call(h,a,e,t)}function s(n){t.utils.isObservable(n)&&n.subscribe(function(){var t=u();"function"==typeof h.update?h.update.call(h,a,e,t):h.call(h,a,e,t)})}function u(){var e={};return i(c,function(n,i){e[n]=t.utils.isObservable(i)?i():i}),e}var a=this,c=t.utils.parseBinding(r,this.context()),h=this.bindings[n];return i(c,function(t,e){s(e)}),o(),this},context:function(t){return"object"==typeof t?(this.contexts.length&&(t.$parent=this.contexts[this.contexts.length-1],t.$root=this.contexts[0]),this.contexts.push(t),this):this.contexts.length?this.contexts[this.contexts.length-1]:!1},restoreContext:function(){return this.contexts.pop(),this}},t.collection=function(e){var n=function(n){Array.prototype.push.apply(this,[]),this.observer=r(this),this.aggregate=function(t,e){var n=[];return e||(e=[t],t=""),this.each(function(r,o){var s=[];i(e,function(t,e){"function"==typeof o[e]&&s.push(o[e]())}),n.push(s.join(t))}),n},this.at=function(t){return this[t]===void 0?!1:this[t]},this.first=function(){return this.at(0)},this.last=function(){return this.at(this.length-1)},this.has=function(t){return this[t]!==void 0},this.remove=function(t){return t="number"==typeof t?t:this.index(t),this.has(t)&&(Array.prototype.splice.call(this,t,1),this.observer.publish()),this},this.empty=function(){return Array.prototype.splice.call(this,0,this.length),this.observer.publish(),this},this.prepend=function(t){return this.insert(0,t)},this.append=function(t){return this.insert(this.length,t)},this.insert=function(n,i){return i=t.utils.isModel(i)?i:new e(i),i.$parent=this.$parent,Array.prototype.splice.call(this,n,0,i),this.observer.publish(),this},this.replace=function(n,i){return i=t.utils.isModel(i)?i:new e(i),i.$parent=this.$parent,Array.prototype.splice.call(this,n,1,i),this.observer.publish(),this},this.index=function(t){var e=-1;return this.each(function(n,i){return i===t?(e=n,void 0):void 0}),e},this.from=function(e){var n=this;return t.utils.isCollection(e)&&(e=e.raw()),i(e,function(t,e){n.has(t)?n.replace(t,e):n.replace(t,e)}),this},this.raw=function(){var t=[];return this.each(function(e,n){t.push(n.raw())}),t},this.each=function(t){for(var e=0;this.length>e;e++)t.call(this,e,this[e]);return this},this.find=function(e,n,r){var o=new this.$self.Model.Collection;return o.$parent=this.$parent,t.utils.isModel(e)&&(e=e.raw()),"object"==typeof e&&(e=function(t){return function(){var e=this,n=!0;return i(t,function(t,i){return e[t]===void 0||e[t]()!==i?(n=!1,!1):void 0}),n}}(e)),this.each(function(t,i){if(n&&r){var s=n*r-n;if(t>s)return}return e.call(i,t)&&o.append(i),n&&o.length===n?!1:void 0}),o},this.findOne=function(t){return this.find(t,1).first()},this["export"]=this.raw,this["import"]=this.from,this.from(n)};return n.Model=e,n.prototype={$self:n},n};var g=function(t,e,n){t.context(n.context)},w=function(e,n,i){var r=i.view||new t.View;i.app||e;var o=i.context;r.target=n,"function"==typeof o&&(o=o()),r.render(i.path,function(){e.bindDescendants(n,o),"function"==typeof i.callback&&i.callback()})},b=function(e,n,i){var r=i.router;r||t.utils.throwForElement(n,'Cannot bind router "'+value+'" to the main view because it does not exist.'),!r instanceof t.Router&&t.utils.throwForElement(n,'Cannot bind router "'+value+'" to the main view because it is not an instanceof "Velcro.Router".'),r.view.target=n,r.bind()},y=function(t,e,n){e.innerText=n.text};t.defaultBindings={context:g,include:w,routable:b,text:y},t.Event=function(){return this.stack=[],this},t.Event.prototype={bind:function(t){return this.stack.push(t),this},unbind:function(t){if(t){var e=[];for(var n in this.stack)this.stack[n]!==t&&e.push(this.stack[n]);this.stack=e}else this.stack=[];return this},once:function(t){var e=this;return this.bind(function(){t.call(t,arguments),e.unbind(t)})},trigger:function(){return this.triggerArgs(Array.prototype.slice.call(arguments,1))},triggerArgs:function(t){for(var e in this.stack)if(this.stack[e].apply(this.stack[e],t)===!1)return!1;return this}},t.Http=function(){return this.before=new t.Event,this.after=new t.Event,this.success=new t.Event,this.error=new t.Event,this.prefix="",this.suffix="",this.headers={},this.parsers={"application/json":function(t){try{return JSON.parse(t)}catch(e){throw'Error parsing response "'+t+'" with message "'+e+'".'}}},this},t.Http.prototype={"delete":function(t){return t.type="delete",this.request(t)},get:function(t){return t.type="get",this.request(t)},head:function(t){return t.type="head",this.request(t)},options:function(t){return t.type="options",this.request(t)},patch:function(t){return t.type="patch",this.request(t)},post:function(t){return t.type="post",this.request(t)},put:function(t){return t.type="put",this.request(t)},request:function(n){var i=this,r=e();n={type:"string"==typeof n.type?n.type.toUpperCase():"GET",url:n.url,data:n.data||{},success:n.success||function(){},error:n.error||function(){},before:n.before||function(){},after:n.done||function(){}},t.utils.isModel(n.data)&&(n.data=n.data.raw()),"object"==typeof n.data&&(n.data=this.serialize(n.data)),n.data&&("get"===n.type?n.url+="?"+n.data:r.setRequestHeader("Content-Type","application/x-www-form-urlencoded")),r.open(n.type,this.prefix+n.url+this.suffix,!0);for(var o in this.headers)r.setRequestHeader(o,this.headers[o]);return r.onreadystatechange=function(){if(4===r.readyState){if(200!==r.status&&304!==r.status)return n.error.call(n.error,r),i.error.trigger(r),n.after.call(n.after,r),i.after.trigger(r),void 0;var t=r.responseText,e=r.getAllResponseHeaders();"string"==typeof e["Content-Type"]&&"function"==typeof i.parsers[e["Content-Type"]]?t=i.parsers[e["Content-Type"]](t):"string"==typeof i.headers.Accept&&"function"==typeof i.parsers[i.headers.Accept]&&(t=i.parsers[i.headers.Accept](t)),n.success.call(n.success,t),i.success.trigger(t),n.after.call(n.after,r),i.after.trigger(r)}},n.before.call(n.before,r),this.before.trigger(r),r.send(n.data),this},serialize:function(t,e){var n=[];for(var i in t){var r=e?e+"["+i+"]":i,o=t[i];n.push("object"==typeof o?this.serialize(o,r):encodeURIComponent(r)+"="+encodeURIComponent(o))}return n.join("&")}},t.model=function(e){var n=function(e){var r=this;this.clone=function(){var t=new n(this.raw());return t.$parent=this.$parent,t},this.from=function(e){return t.utils.isModel(e)&&(e=e.raw()),i(e,function(t,e){"function"==typeof r[t]&&r[t](e)}),this.observer.publish(),this},this.raw=function(){var t={};return i(r.$self.properties,function(e){t[e]=r[e]()}),i(r.$self.computed,function(e){t[e]=r[e]()}),i(r.$self.relations,function(e){t[e]=r[e]().raw()}),t},this.reset=function(){return i(r.$self.properties,function(t,e){r[t](e)}),this},this["export"]=this.raw,this["import"]=this.from,s(this),this.from(e),"function"==typeof this.init&&this.init()};return n.Collection=t.collection(n),n.computed={},n.methods={},n.properties={},n.relations={},n.prototype.$self=n,n.extend=function(e){return e=t.utils.isModel(e)?e:t.model(e),i(n.computed,function(t,n){e.computed[t]===void 0&&(e.computed[t]=n)}),i(n.methods,function(t,n){e.methods[t]===void 0&&(e.methods[t]=n)}),i(n.properties,function(t,n){e.properties[t]===void 0&&(e.properties[t]=n)}),i(n.relations,function(t,n){e.relations[t]===void 0&&(e.relations[t]=n)}),e},n.inherit=function(t){return t.extend(n)},o(n,e),n};var m=[];t.Router=function(){return this.app=new t.App,this.enter=new t.Event,this.exit=new t.Event,this.params={},this.render=new t.Event,this.route=!1,this.routes={},this.state=new t.State,this.view=new t.View,this},t.Router.prototype={handler:function(t){t()},renderer:function(e,n){var i=this,r=e.controller.apply(e.controller,n);t.utils.isModel(r)||(r=new(t.model(r))),this.view.render(e.view,function(t){i.app.bindDescendants(t.target,r),i.render.trigger(i,e,n)})},bind:function(){return this.unbind(),m.push(this),"onpopstate"in window&&this.state.enabled&&(!this.state.enabled||window.location.hash)||this.dispatch(),this},unbind:function(){for(var t=0;m.length>t;t++)this===m[t]&&delete m[t];return this},set:function(e,n){return"function"==typeof n&&(n={match:RegExp("^"+e+"$"),format:e,controller:n}),n.view||(n.view=e),this.routes[e]=n instanceof t.Route?n:new t.Route(n),this},get:function(t){if(this.has(t))return this.routes[t];throw'Route "'+t+'" does not exist.'},has:function(t){return this.routes[t]!==void 0},remove:function(t){return this.has(t)&&delete this.routes[t],this},dispatch:function(t){var e=this;t===void 0&&(t=this.state.get());var n=function(){e.renderer(r)};for(var i in this.routes){var r=this.routes[i],o=r.query(t);"number"==typeof o.length&&(this.route&&this.exit.trigger(this,this.state.previous,this.route,this.params),this.enter.trigger(this,t,r,o),this.params=o,this.route=r,this.state.previous=t,this.handler(n))}return this},go:function(t,e,n){return this.state.push(this.get(t).generate(e),n),this},generate:function(t,e){return this.get(t).generate(e)}},t.Route=function(t){for(var e in t)this[e]=t[e];return this},t.Route.prototype={match:/.*/,format:"",view:!1,controller:function(){},query:function(t){var e=t.match(this.match);return null===e?!1:(e.shift(),e)},generate:function(t){var e=this.format;for(var n in t)e=e.replace(RegExp("\\:"+n,"g"),t[n]);return e}};var x,E=window.location.hash,M=!1;t.State=function(){return this.states={},t.State.start(),this},t.State.interval=500,t.State.start=function(){if(M)return t.State;var e="onhashchange"in window&&/MSIE\s(6|7)/.test(navigator.userAgent);return"onpopstate"in window?p("popstate"):e?(p("hashchange"),x=setInterval(function(){E!==window.location.hash&&(E=window.location.hash,l("hashchange"))},t.State.interval)):p("hashchange"),M=!0,t.State},t.State.stop=function(){x&&clearInterval(x);var t="onpopstate"in window?"popstate":"hashchange";return window.removeEventListener?window.removeEventListener(t,v):window[t]&&delete window[t],M=!1,State},t.State.prototype={previous:!1,enabled:!1,scroll:!1,get:function(){return this.enabled&&window.history.pushState?f(window.location.href):window.location.hash.substring(1)},push:function(t,e,n){return this.enabled&&window.history.pushState?(window.history.pushState(e,n,t||"."),v()):d(t,this.scroll),this.states[t]=e,this},data:function(t){return t=t||this.get(),this.states[t]===void 0?null:this.states[t]}},t.utils={parseBinding:function(t,e){var n="";for(var i in e||{})"import"!==i&&"export"!==i&&""!==i&&(n+="var "+i+"=__context['"+i+"'];");n+="return {"+t+"};";try{return Function("__context",n)(e)}catch(r){throw'Error parsing binding "'+t+'" with message: "'+r+'"'}},isObservable:function(e){return"function"==typeof e&&""+e==""+t.value()},html:function(t){var e=document.createElement("div");return e.appendChild(t),e.innerHTML},throwForElement:function(e,n){throw n+"\n"+t.html(e)},isModel:function(e){return n(e,""+t.model())},isCollection:function(e){return n(e,""+t.collection())}},t.value=function(t){var e=function(t){return 0===arguments.length?e.get.call(e.bind):(e.set.call(e.bind,t),e.publish(),e.bind)};t||(t={}),"function"!=typeof t.get&&(t.get=function(){return e.value}),"function"!=typeof t.set&&(t.set=function(t){e.value=t});var n=[];return e.value=t.value,e.bind=t.bind,e.get=t.get,e.set=t.set,e.subscribe=function(t){return n.push(t),e},e.unsubscribe=function(t){return i(n,function(e,i){return t===i?(n.splice(e,1),void 0):void 0}),e},e.publish=function(){return i(n,function(t,n){n(e.value)}),e},e},t.View=function(){return this.cache={},this.http=new t.Http,this.http.prefix="views/",this.http.suffix=".html",this.http.accept="text/html",this},t.View.prototype={http:!1,target:null,idPrefix:"Velcro-view-",idSuffix:"",idSeparator:"-",render:function(t,e){var n=this,i=this.idPrefix+t.replace(/\//g,this.idSeparator)+this.idSuffix,r=function(){"function"==typeof e&&e.call(e,n,t)};return this.cache[t]?(this.renderer(this.cache[t]),r()):document.getElementById(i)?(this.renderer(this.cache[t]=document.getElementById(i).innerHTML),r()):this.http&&this.http.get({url:t,success:function(e){n.renderer(n.cache[t]=e),r()}}),this},renderer:function(t){var e=this.target;if(!e)throw"Cannot render view because no target was specified.";"string"==typeof e?e=document.getElementById(e):"function"==typeof e&&(e=e()),e.innerHTML=t}}});